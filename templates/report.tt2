[%- # This is the generic WormBase Report page             -%]
[%- # Stash contents should contain:                       -%]
[%- #    current_object - the object being displayed       -%]
[%- #    widgets - a list of widgets supported by the page -%]
[%- #    title   - the title of the page                   -%]


[% SET this_object_id    = object.name.data.id %]
[% SET this_object_label = object.name.data.label %]
  
   [% path = 'reports' _ '/' _ class _ '/' _ this_object_id %]
[% # Sidebar View %]
[% IF view=="sidebar" || (view == "") %]

  [%- IF object -%]
    [% upperClass = class FILTER ucfirst %]
    [% title = upperClass _ " Report: " _ tag2link(object.name.data)  %]
    [%# PROCESS "shared/page_title.tt2" no_star=0 %]
  [% ELSE %]
    [% title = "My Workspace"  %]
    [%# PROCESS "shared/page_title.tt2" no_star=1 %]
  [% END %] 


  [% widgets = [] %]
  [% widgets.push({ title="Page Content" type="title"}) %]
  [% widget_list = c.config.pages.$class.widgets.keys.sort %]
  [% IF object; widget_list.unshift('overview'); END; %]
  [% widget_list = widget_list.unique %]
  [% FOREACH widget_name IN widget_list -%]
    [% IF ((widget_name == 'profile') AND (NOT (c.user_exists))); NEXT; END; %]

    
    [% widget = c.config.pages.$class.widgets.$widget_name %]
    [% w = { id = widget_name
             title = widget.title
             href =  c.uri_for('/rest','widget',class,this_object_id,widget.name)
             type = class
            };
    %]
    [% widgets.push(w) %]
  [% END %]

  [% IF object %]
    [% widgets.push({ title="My Workspace" type="title"}) %]
    [% FOREACH widget_name IN ['reports', 'my_library'] -%]
      [% widget = c.config.pages.bench.widgets.$widget_name %]
      [% w = { id = widget_name
              title = widget.title
              href =  c.uri_for('/rest','widget','bench','a',widget_name)
              type = "bench"
              };
      %]
      [% widgets.push(w) %]
    [% END %]
  [% END %]

[% PROCESS "shared/sidebar_structure.tt2" widgets=widgets%]

    <script>
  [% UNLESS c.user_session.layout.$class.defined %]
    $jq("#nav-overview").trigger('open');
    $jq("#nav-location").trigger('open');
    [% UNLESS object %]
      resetLayout(["reports"], ["my_library"], 50);
    [% END %]
  [% ELSE %]
    var leftList = ["[% c.user_session.layout.$class.0.left.join('", "') %]"];
    var rightList = ["[% c.user_session.layout.$class.0.right.join('", "') %]"];
    resetLayout(leftList, rightList, [% c.user_session.layout.$class.0.leftWidth %]);
  [% END %]

    </script>

[% ELSE %]

<div class="title">
   [% title %]
   [%- IF object -%]
     <h2>[% class FILTER ucfirst %] Report: [%- tag2link(object.name.data) -%]</h2>
   [% END %] 
  <nav id="available-views">
    View as:
    [% # HARD-CODED! %]   
    [% SET my_url = join("/","reports",class,$object.this_object_id,'/?view=') %]
    <a href="/reports/[%- class _ '/' _ this_object_id -%]/?view=sidebar">sidebar</a> |
    <a href="/reports/[%- class _ '/' _ this_object_id -%]/?view=tabs">tabs</a> |
    <a href="/reports/[%- class _ '/' _ this_object_id -%]/?view=paned">paned</a> |
    <a href="/reports/[%- class _ '/' _ this_object_id -%]/?view=page">full page</a> |
    [% tag2link(object.name.data,'classic','is_classic') %]
  </nav>
</div>


[%# A two panel selector view.
     The sidebar contains panels
    A paned view with a sidebar TOC and content displayed in the main pane onClick %]

[% IF view=="paned" %]

   <div id="sidebar">
        <ul class="">
             [% FOREACH widget_name IN widgets -%]
                [% widget = c.config.pages.$class.widgets.$widget_name %]
                <!-- The REST URI is: [% c.uri_for('/rest','widget',this_page,random_object,widget) %]" -->
                    <li>
                        <a class="ajax content-pane" href="[% c.uri_for('/rest','widget',class,this_object_id,widget.name) %]">
                           <span>[% widget.title FILTER ucfirst %]</span>
                        </a>
                   </li>
             [% END %]
         </ul>
    </div>

      <div id="content-pane"></div>
                     <script>
                            $jq("#content-pane").load("[% c.uri_for('/rest','widget',this_page,this_object_id,widget.name) %]",
                               function(response, status, xhr) {
                                            if (status == "error") {
                                                var msg = "Sorry but there was an error: ";
                                                $jq("#error").html(msg + xhr.status + " " + xhr.statusText);
                                            } 
                                     });
                            </script>






[% # Tabbed View, loaded onClick; this is also the default view %]
[% ELSIF view=="tabs" %]

   <div id="tabs">
      <div class="ui-tabs">
          <ul class="ui-tabs-nav">
             [% FOREACH widget_name IN widgets -%]
                  [% widget = c.config.pages.$class.widgets.$widget_name %]
                  <li>
                       <a href="/rest/widget/[% class %]/[% this_object_id %]/[% widget.name %]">
                             <span>[% widget.title %]</span>
                       </a>
                  </li>
             [% END %]
          </ul>
       </div>
   </div>



[%# All widgets on one page, loaded by ajax. This is esentially 
    what the current site is, less the ajax loading %]

[% ELSIF view=="page" %]

           [% FOREACH widget_name IN c.config.pages.$class.widget_order %]
              [% widget = c.config.pages.$class.widgets.$widget_name %]
                    [% WRAPPER $widget_block -%]
                          [%#- This is a little goofy. Let me explain.
                               What we are doing here is preparing the widget
                               and markup as a target for an ajax request.
                               This lets us display widget headers above
                               containers which are then filled by ajax.
                   
                   For the classic view, this includes building 
                   a nested table structure.

                               Although we could place the WRAPPER in each widget
                               template proper, widget headers are then displayed
                               once the content has returned.

                   The upshot of this is that widgets are not self-contained.
                   I'm not entirely psyched about that. Something to ponder.
                   %]                               
                    [% END %]

            [%# This is a work in progress: I want to sequentially load widgets.
                Firefox does this using the existing code, but other browsers do not.           
            %] 
           <!-- <div class="dynamic-widget"><a href="[% c.uri_for('/rest','widget',class,this_object_id,widget.name) %]">[% widget.name %]</a></div>-->

                    <script>
                             $jq("#[%- widget.name -%]").load("[% c.uri_for('/rest','widget',class,this_object_id,widget.name) %]",
                           function(response, status, xhr) {
                                          if (status == "error") {
                                             var msg = "Sorry but there was an error: ";
                                             $jq("#error").html(msg + xhr.status + " " + xhr.statusText);
                                           } 
                                    })                    
                   </script>

      [% END %]
[% END %]
[% END %]
 

